name: Production Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version from package.json (e.g., 1.0.0 or 1.0.0-beta.1). Do NOT include the "v" prefix.'
        required: true
        type: string

jobs:
  release:
    name: Release
    environment: Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write  # Required to create and push tags

    env:
      PROJECT_NAME: '@defi-wonderland/aztec-standards'

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.17.0"
          registry-url: "https://registry.npmjs.org"
          cache: "yarn"

      # TODO: Automate changing package.json version from the workflow input
      #       (e.g., open a PR or push a signed commit) so manual edits are not required.
      - name: Validate input version matches package.json
        run: |
          INPUT_VERSION="${{ github.event.inputs.version }}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "Input version: $INPUT_VERSION"
          echo "package.json version: $PKG_VERSION"
          if [ "$INPUT_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Input version ($INPUT_VERSION) does not match package.json version ($PKG_VERSION). Update package.json or re-run with the matching version (no 'v' prefix)."
            exit 1
          fi

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Detect Aztec version
        id: aztec-version
        run: |
          AZTEC_VERSION=$(node -p "require('./package.json').config.aztecVersion")
          echo "version=$AZTEC_VERSION" >> "$GITHUB_OUTPUT"
          echo "Aztec version is $version"

      - name: Install Aztec CLI
        run: |
          curl -s https://install.aztec.network > tmp.sh
          bash tmp.sh <<< yes "yes"
      - name: Update path
        run: echo "/home/runner/.aztec/bin" >> $GITHUB_PATH

      - name: Set Aztec version
        run: |
          VERSION=${{ steps.aztec-version.outputs.version }} aztec-up

      # This is a temporary hack to fix a problem with v3 releases.
      - name: Manually tag the aztec version as `latest`
        run: |
          docker tag aztecprotocol/aztec:${{ steps.aztec-version.outputs.version }} aztecprotocol/aztec:latest

      - name: Install dependencies
        run: yarn --frozen-lockfile

      - name: Compile
        run: yarn compile

      - name: Codegen
        run: aztec codegen target --outdir artifacts

      - name: Compile artifacts to JS
        run: |
          mkdir -p dist/
          yarn tsc artifacts/*.ts --outDir dist/ --skipLibCheck --target es2020 --module nodenext --moduleResolution nodenext --resolveJsonModule --declaration

      # TODO: We do several things here:
      # 1. Create artifacts directory
      # 2. Copy compiled JS artifacts to artifacts/
      # 3. Copy compiled Noir contracts (target/) to package root
      # 4. Copy deployments.json to package root (if exists)
      # 5. Copy README.md and LICENSE to package root
      # 6. Create trimmed package.json
      - name: Prepare files for release
        run: |
          VERSION=${{ github.event.inputs.version }}
          mkdir -p export/${{ env.PROJECT_NAME }}/artifacts

          # Copy the compiled JS files to artifacts/
          cp -r dist/artifacts/* export/${{ env.PROJECT_NAME }}/artifacts/

          # Copy compiled Noir contracts to package root
          cp -r target export/${{ env.PROJECT_NAME }}/

          # Copy deployments.json if it exists
          if [ -f "src/deployments.json" ]; then
            cp src/deployments.json export/${{ env.PROJECT_NAME }}/
          else
            echo "src/deployments.json not found, skipping copy"
          fi
          
          cp README.md export/${{ env.PROJECT_NAME }}/
          cp LICENSE export/${{ env.PROJECT_NAME }}/

          cat package.json | jq --arg v "$VERSION" 'del(.scripts, .jest, ."lint-staged", .packageManager, .devDependencies, .dependencies, .engines, .resolutions) | .version=$v' > export/${{ env.PROJECT_NAME }}/package.json

      - name: Publish to NPM
        run: cd export/${{ env.PROJECT_NAME }} && npm publish --access public --tag latest --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release Tag (adds 'v' prefix to input)
        run: |
          TAG_NAME="v${{ github.event.inputs.version }}"
          # Check if tag already exists
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG_NAME}$"; then
            echo "::error::Tag ${TAG_NAME} already exists. Please use a different version."
            exit 1
          fi
          git tag "${TAG_NAME}"
          git push origin "${TAG_NAME}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}